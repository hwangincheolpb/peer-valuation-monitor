<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Peer Valuation Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#0f1117', surface: '#1a1d29', surface2: '#22253a',
                        border: '#2a2d3a', muted: '#6b7280',
                        cheap: '#22c55e', expensive: '#ef4444', neutral: '#f59e0b',
                    }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; }
        body { background: #0f1117; color: #e5e7eb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin:0; }
        .sidebar { width: 240px; min-width: 240px; height: 100vh; overflow-y: auto; position: sticky; top: 0; }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: #2a2d3a; border-radius: 2px; }
        .group-header { padding: 6px 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #6b7280; cursor: pointer; display: flex; align-items: center; justify-content: space-between; user-select: none; margin-top: 4px; }
        .group-header:hover { color: #9ca3af; }
        .group-header .chevron { font-size: 8px; transition: transform 0.15s; }
        .group-header.collapsed .chevron { transform: rotate(-90deg); }
        .group-items.collapsed { display: none; }
        .cat-item { padding: 6px 16px 6px 20px; cursor: pointer; border-left: 3px solid transparent; transition: all 0.15s; font-size: 12px; }
        .cat-item:hover { background: #1a1d29; }
        .cat-item.active { background: #1a1d29; border-left-color: #3b82f6; color: white; }
        .alert-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; flex-shrink: 0; }
        .alert-red { background: #ef4444; box-shadow: 0 0 6px #ef444466; }
        .alert-yellow { background: #f59e0b; }
        .alert-green { background: #22c55e; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th { position: sticky; top: 0; z-index: 10; cursor: pointer; user-select: none; }
        th:hover { background: #22253a !important; }
        .sort-icon { opacity: 0.3; font-size: 10px; }
        th:hover .sort-icon, th.sorted .sort-icon { opacity: 1; }
        tr:hover td { background: #1e2130; }
        .metric-cell { font-variant-numeric: tabular-nums; }
        .revision-up { color: #22c55e; }
        .revision-down { color: #ef4444; }
        .peer-avg-row td { border-top: 2px solid #3b82f6; font-weight: 600; background: #151825 !important; }
        .shortage-chip { font-size: 11px; padding: 2px 8px; border-radius: 10px; display: inline-flex; align-items: center; gap: 4px; }
        .shortage-chip.red { background: #ef444420; color: #ef4444; border: 1px solid #ef444440; }
        .shortage-chip.yellow { background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b40; }
        .shortage-chip.green { background: #22c55e20; color: #22c55e; border: 1px solid #22c55e40; }
        .shortage-detail { font-size: 12px; padding: 6px 10px; background: #151825; border-radius: 6px; border: 1px solid #2a2d3a; }
        .stat-card { background: #1a1d29; border: 1px solid #2a2d3a; border-radius: 8px; padding: 12px 16px; }
        .tab-btn { padding: 8px 16px; font-size: 13px; color: #6b7280; border: none; border-bottom: 2px solid transparent; cursor: pointer; background: transparent; transition: all 0.15s; }
        .tab-btn:hover { color: #9ca3af; }
        .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        #stockModal { backdrop-filter: blur(4px); }
        .group-header.active { color: #3b82f6; background: #1a1d2960; }
        .subcat-divider td { background: #151825 !important; padding: 6px 12px !important; font-size: 12px; font-weight: 700; color: #60a5fa; border-left: 3px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="flex">
        <!-- Sidebar -->
        <aside class="sidebar border-r border-border bg-bg">
            <div class="px-4 py-4 border-b border-border">
                <h1 class="text-sm font-bold text-white tracking-wide">PEER VALUATION</h1>
                <p class="text-xs text-muted mt-0.5">Global Supply-Valuation Monitor</p>
            </div>
            <div id="sidebarList" class="py-2"></div>
            <div class="px-4 py-3 border-t border-border text-xs text-muted">
                <div id="lastUpdated">Loading...</div>
                <div id="stockCount" class="mt-1"></div>
            </div>
        </aside>

        <!-- Main -->
        <main class="flex-1 overflow-auto h-screen">
            <!-- Category Header -->
            <div class="px-6 py-4 border-b border-border bg-surface/50 sticky top-0 z-20 backdrop-blur">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="catTitle" class="text-lg font-bold text-white"></h2>
                        <span id="catTitleEn" class="text-sm text-muted"></span>
                    </div>
                    <div id="shortageChips" class="flex gap-2 flex-wrap"></div>
                </div>
            </div>

            <!-- Shortage Detail -->
            <div id="shortageDetail" class="px-6 pt-3 hidden">
                <div class="flex gap-2 overflow-x-auto pb-2" id="shortageCards"></div>
            </div>

            <!-- Summary Cards -->
            <div class="px-6 py-3">
                <div id="summaryCards" class="grid grid-cols-5 gap-3"></div>
            </div>

            <!-- Chart -->
            <div class="px-6 pb-3">
                <div class="bg-surface rounded-lg border border-border p-4">
                    <div class="flex gap-1 mb-3 border-b border-border pb-2">
                        <button id="tabScatter" class="tab-btn active" onclick="switchTab('scatter')">Scatter Plot</button>
                        <button id="tabTimeSeries" class="tab-btn" onclick="switchTab('timeseries')">Time Series</button>
                    </div>
                    <div id="scatterContainer" style="height:300px; position:relative;">
                        <canvas id="scatterChart"></canvas>
                    </div>
                    <div id="timeSeriesContainer" style="height:300px; position:relative; display:none;">
                        <canvas id="timeSeriesChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="px-6 pb-6">
                <div class="overflow-x-auto rounded-lg border border-border">
                    <table class="text-sm" id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div class="mt-3 flex gap-6 text-xs text-muted">
                    <span><span class="inline-block w-2.5 h-2.5 rounded bg-cheap mr-1 align-middle"></span>í”¼ì–´ í‰ê·  ëŒ€ë¹„ ì €í‰ê°€</span>
                    <span><span class="inline-block w-2.5 h-2.5 rounded bg-expensive mr-1 align-middle"></span>í”¼ì–´ í‰ê·  ëŒ€ë¹„ ê³ í‰ê°€</span>
                    <span>EPS Rev: 30ì¼ê°„ consensus EPS ë³€í™”ìœ¨</span>
                    <span>Source: Yahoo Finance (S&P Global) + Structural Shortage Dashboard</span>
                </div>
            </div>
        </main>
    </div>

<!-- Stock Detail Modal -->
<div id="stockModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4" onclick="if(event.target===this)closeModal()">
    <div class="bg-surface rounded-lg border border-border max-w-3xl w-full max-h-[90vh] overflow-hidden">
        <div class="px-5 py-3 border-b border-border flex items-center justify-between">
            <div>
                <h3 id="modalName" class="text-base font-bold text-white"></h3>
                <span id="modalSymbol" class="text-xs text-muted"></span>
            </div>
            <button onclick="closeModal()" class="text-muted hover:text-white text-xl leading-none">&times;</button>
        </div>
        <div class="p-5 overflow-y-auto" style="max-height:calc(90vh - 56px)">
            <div class="bg-bg rounded-lg border border-border p-3 mb-4" style="height:320px">
                <canvas id="modalChart"></canvas>
            </div>
            <div id="modalStats" class="grid grid-cols-4 gap-3"></div>
        </div>
    </div>
</div>

<script>
const DATA_URL = 'data/valuation-data.json';
const FLAGS = {KR:'ğŸ‡°ğŸ‡·',US:'ğŸ‡ºğŸ‡¸',TW:'ğŸ‡¹ğŸ‡¼',JP:'ğŸ‡¯ğŸ‡µ',NL:'ğŸ‡³ğŸ‡±',UK:'ğŸ‡¬ğŸ‡§',DE:'ğŸ‡©ğŸ‡ª',SG:'ğŸ‡¸ğŸ‡¬',DK:'ğŸ‡©ğŸ‡°',CH:'ğŸ‡¨ğŸ‡­',FR:'ğŸ‡«ğŸ‡·',CN:'ğŸ‡¨ğŸ‡³',CA:'ğŸ‡¨ğŸ‡¦',AU:'ğŸ‡¦ğŸ‡º',BR:'ğŸ‡§ğŸ‡·',CL:'ğŸ‡¨ğŸ‡±',BE:'ğŸ‡§ğŸ‡ª',NO:'ğŸ‡³ğŸ‡´',IT:'ğŸ‡®ğŸ‡¹',KZ:'ğŸ‡°ğŸ‡¿'};

const COLUMNS = [
    { key: 'name', label: 'ì¢…ëª©', align: 'left', w: 'min-w-[180px]' },
    { key: 'currentPrice', label: 'í˜„ì¬ê°€', align: 'right', format: 'price' },
    { key: 'marketCapFormatted', label: 'ì‹œì´', align: 'right' },
    { key: 'forwardPE', label: 'Fwd P/E', align: 'right', format: '1f', colorMode: 'pe' },
    { key: 'change1d', label: 'Î”1D', align: 'center', format: 'change', w: 'w-[56px]' },
    { key: 'change7d', label: 'Î”7D', align: 'center', format: 'change', w: 'w-[56px]' },
    { key: 'change30d', label: 'Î”30D', align: 'center', format: 'change', w: 'w-[56px]' },
    { key: 'trailingPE', label: 'Trail P/E', align: 'right', format: '1f' },
    { key: 'priceToBook', label: 'P/B', align: 'right', format: '2f' },
    { key: 'enterpriseToEbitda', label: 'EV/EBITDA', align: 'right', format: '1f', colorMode: 'pe' },
    { key: 'returnOnEquity', label: 'ROE', align: 'right', format: 'pct' },
    { key: 'dividendYield', label: 'ë°°ë‹¹ë¥ ', align: 'right', format: 'pct' },
    { key: 'fwd1y_growth', label: 'EPS ì„±ì¥', align: 'right', format: 'ratioSigned', colorMode: 'growth' },
    { key: 'epsRevision30d', label: 'EPS Rev', align: 'right', format: 'directPct', colorMode: 'revision' },
    { key: 'targetUpside', label: 'TP ê´´ë¦¬', align: 'right', format: 'directPct', colorMode: 'revision' },
    { key: 'fwd1y_numAnalysts', label: 'ì• ë„', align: 'center', format: 'd' },
];

let allData = null;
let currentCat = 0;
let currentGroup = null;
let sortCol = 'forwardPE';
let sortAsc = true;

async function loadData() {
    try {
        const resp = await fetch(DATA_URL);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        allData = await resp.json();
        renderSidebar();
        renderCategory(0);
        renderMeta();
        preloadHistory();
    } catch (e) {
        document.getElementById('tableBody').innerHTML =
            `<tr><td colspan="13" class="text-center py-12 text-muted">
                ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. <code>python3 fetch_data.py</code> ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.
            </td></tr>`;
    }
}

function renderMeta() {
    const dt = new Date(allData.fetchedAt);
    document.getElementById('lastUpdated').textContent =
        `${dt.toLocaleDateString('ko-KR')} ${dt.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit'})}`;
    document.getElementById('stockCount').textContent =
        `${allData.successCount}/${allData.totalStocks} stocks`;
}

function renderSidebar() {
    const el = document.getElementById('sidebarList');
    // group categories by group field
    const groups = [];
    const groupMap = {};
    allData.categories.forEach((cat, i) => {
        const g = cat.group || 'ê¸°íƒ€';
        if (!(g in groupMap)) {
            groupMap[g] = groups.length;
            groups.push({ name: g, items: [] });
        }
        groups[groupMap[g]].items.push({ cat, idx: i });
    });

    el.innerHTML = groups.map((group, gi) => {
        const items = group.items.map(({ cat, idx }) => {
            const alert = cat.alertSummary;
            const dot = alert ? `<span class="alert-dot alert-${alert}"></span>` : '<span style="width:14px;display:inline-block"></span>';
            const badge = cat.shortageCount
                ? `<span class="text-xs px-1 py-0 rounded-full ml-auto
                    ${alert === 'red' ? 'bg-red-500/20 text-red-400' : alert === 'yellow' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-green-500/20 text-green-400'}"
                  >${cat.shortageCount}</span>`
                : '';
            return `<div class="cat-item flex items-center ${idx === 0 ? 'active' : ''}" data-idx="${idx}" onclick="renderCategory(${idx})">
                ${dot}<span class="truncate">${cat.name}</span>${badge}
            </div>`;
        }).join('');
        return `<div class="group-header" data-group="${group.name}" onclick="renderGroupView('${group.name.replace(/'/g, "\\'")}')">
            <span>${group.name}</span>
            <span class="text-xs text-muted ml-1">${group.items.length}</span>
        </div>
        <div class="group-items">${items}</div>`;
    }).join('');
}

function renderCategory(idx) {
    currentCat = idx;
    currentGroup = null;
    document.querySelectorAll('.cat-item').forEach((el, i) => el.classList.toggle('active', i === idx));
    document.querySelectorAll('.group-header').forEach(el => el.classList.remove('active'));

    const cat = allData.categories[idx];

    // Header
    document.getElementById('catTitle').textContent = cat.name;
    document.getElementById('catTitleEn').textContent = cat.name_en;

    // Shortage chips
    renderShortageChips(cat);

    // Shortage detail cards
    renderShortageDetail(cat);

    // Summary
    renderSummary(cat);

    // Chart
    renderScatter(cat.stocks || [], (cat.peerAvg || {}).forwardPE);
    if (tsChart) { tsChart.destroy(); tsChart = null; }
    if (activeTab === 'timeseries') renderTimeSeries();

    // Table
    renderTable(cat);
}

function renderShortageChips(cat) {
    const el = document.getElementById('shortageChips');
    if (!cat.shortage || cat.shortage.length === 0) {
        el.innerHTML = '<span class="text-xs text-muted">ì‡¼í‹°ì§€ ë°ì´í„° ì—†ìŒ</span>';
        return;
    }
    el.innerHTML = cat.shortage.map(s =>
        `<span class="shortage-chip ${s.alertLevel}">
            <span class="alert-dot alert-${s.alertLevel}" style="margin:0"></span>
            ${s.name}
        </span>`
    ).join('');
}

function renderShortageDetail(cat) {
    const container = document.getElementById('shortageDetail');
    const cards = document.getElementById('shortageCards');
    if (!cat.shortage || cat.shortage.length === 0) {
        container.classList.add('hidden');
        return;
    }
    container.classList.remove('hidden');
    cards.innerHTML = cat.shortage.map(s => {
        const items = [
            s.priceYoY != null ? `ê°€ê²© YoY <b>+${s.priceYoY}%</b>` : null,
            s.utilization != null ? `ê°€ë™ë¥  <b>${s.utilization}%</b>` : null,
            s.inventory != null ? `ì¬ê³  <b>${s.inventory}ê°œì›”</b>` : null,
            s.leadTime != null ? `ë¦¬ë“œíƒ€ì„ <b>${s.leadTime}ë…„</b>` : null,
        ].filter(Boolean).join(' Â· ');
        return `<div class="shortage-detail flex-shrink-0">
            <span class="alert-dot alert-${s.alertLevel}"></span>
            <b>${s.name}</b>
            <span class="text-muted ml-2">${items}</span>
        </div>`;
    }).join('');
}

function renderSummary(cat) {
    const avg = cat.peerAvg || {};
    const cards = [
        { label: 'Fwd P/E', value: fmt(avg.forwardPE, '1f'), sub: `med ${fmt(avg.forwardPE_median, '1f')}` },
        { label: 'EV/EBITDA', value: fmt(avg.enterpriseToEbitda, '1f'), sub: `med ${fmt(avg.enterpriseToEbitda_median, '1f')}` },
        { label: 'EPS Growth', value: fmt(avg.fwd1y_growth, 'ratioSigned'), sub: '+1Y consensus' },
        { label: 'EPS Revision', value: fmt(avg.epsRevision30d, 'directPct'), sub: '30d change' },
        { label: 'TP Upside', value: fmt(avg.targetUpside, 'directPct'), sub: 'vs mean target' },
    ];
    document.getElementById('summaryCards').innerHTML = cards.map(c => {
        const color = c.label.includes('EPS') || c.label.includes('TP')
            ? (parseVal(c.value) > 0 ? 'text-cheap' : parseVal(c.value) < 0 ? 'text-expensive' : 'text-white')
            : 'text-white';
        return `<div class="stat-card">
            <div class="text-xs text-muted">${c.label}</div>
            <div class="text-lg font-bold ${color} mt-1">${c.value || '-'}</div>
            <div class="text-xs text-muted mt-0.5">${c.sub || ''}</div>
        </div>`;
    }).join('');
}

function parseVal(str) {
    if (!str || str === '-') return 0;
    return parseFloat(str.replace(/[+%,<>]/g, '')) || 0;
}

function renderTable(cat) {
    document.getElementById('tableHead').innerHTML = '<tr>' + COLUMNS.map(col =>
        `<th class="px-3 py-2 text-xs font-medium text-muted bg-surface border-b border-border
                    text-${col.align} ${col.w || ''} ${sortCol === col.key ? 'sorted' : ''}"
            onclick="toggleSort('${col.key}')">
            ${col.label} <span class="sort-icon">${sortCol === col.key ? (sortAsc ? 'â–²' : 'â–¼') : 'â†•'}</span>
        </th>`
    ).join('') + '</tr>';

    let stocks = [...cat.stocks].filter(s => !s.error);
    stocks.sort((a, b) => {
        let va = a[sortCol], vb = b[sortCol];
        if (va == null && vb == null) return 0;
        if (va == null) return 1;
        if (vb == null) return -1;
        if (typeof va === 'string') return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
        return sortAsc ? va - vb : vb - va;
    });

    const avg = cat.peerAvg || {};

    const rows = stocks.map(stock =>
        `<tr class="border-b border-border/30 cursor-pointer hover:bg-surface2/50" onclick="openModal('${stock.symbol}','${stock.name.replace(/'/g, "\\'")}')">` + COLUMNS.map(col => {
            const val = stock[col.key];
            if (col.key === 'name') {
                const flag = FLAGS[stock.country] || '';
                return `<td class="px-3 py-2 text-left ${col.w || ''}">
                    <span class="text-xs">${flag}</span>
                    <span class="font-medium text-white">${stock.name}</span>
                    <span class="text-muted text-xs ml-1">${stock.symbol}</span>
                </td>`;
            }
            const display = fmt(val, col.format, stock.currency);
            const color = getColor(col, val, avg);
            return `<td class="px-3 py-2 text-${col.align} metric-cell ${color}">${display}</td>`;
        }).join('') + '</tr>'
    ).join('');

    const avgRow = '<tr class="peer-avg-row">' + COLUMNS.map(col => {
        if (col.key === 'name') return '<td class="px-3 py-2 text-left text-blue-400">Peer Average</td>';
        return `<td class="px-3 py-2 text-${col.align} metric-cell">${fmt(avg[col.key], col.format)}</td>`;
    }).join('') + '</tr>';

    document.getElementById('tableBody').innerHTML = rows + avgRow;
}

function fmt(val, format) {
    if (val == null || val === undefined) return '<span class="text-muted">-</span>';
    switch (format) {
        case 'change': {
            const color = val < 0 ? 'text-cheap' : val > 0 ? 'text-expensive' : 'text-muted';
            const arrow = val < 0 ? 'â†“' : val > 0 ? 'â†‘' : 'â†’';
            return `<span class="${color} text-xs font-medium">${arrow}${Math.abs(val).toFixed(1)}%</span>`;
        }
        case '1f': return Number(val).toFixed(1);
        case '2f': return Number(val).toFixed(2);
        case 'd': return Math.round(val).toString();
        case 'pct': {
            const v = val * 100;
            return v.toFixed(1) + '%';
        }
        case 'ratioSigned': {
            const v = val * 100;
            if (v > 999) return '>999%';
            if (v < -999) return '<-999%';
            return (v > 0 ? '+' : '') + v.toFixed(1) + '%';
        }
        case 'directPct': {
            return (val > 0 ? '+' : '') + Number(val).toFixed(1) + '%';
        }
        case 'price': {
            if (val >= 10000) return Number(val).toLocaleString('ko-KR', { maximumFractionDigits: 0 });
            if (val >= 100) return Number(val).toFixed(1);
            return Number(val).toFixed(2);
        }
        default: return String(val);
    }
}

function getColor(col, val, avg) {
    if (val == null || !col.colorMode) return '';
    if (col.colorMode === 'pe') {
        const a = avg[col.key];
        if (a == null) return '';
        if (val < a * 0.85) return 'text-cheap font-medium';
        if (val > a * 1.15) return 'text-expensive';
        return '';
    }
    if (col.colorMode === 'growth') {
        const v = val * 100;
        if (v > 5) return 'revision-up';
        if (v < -5) return 'revision-down';
        return '';
    }
    if (col.colorMode === 'revision') {
        if (val > 2) return 'revision-up';
        if (val < -2) return 'revision-down';
        return '';
    }
    return '';
}

function toggleSort(key) {
    if (sortCol === key) sortAsc = !sortAsc;
    else { sortCol = key; sortAsc = true; }
    if (currentGroup) renderGroupView(currentGroup);
    else renderCategory(currentCat);
}

function renderGroupView(groupName) {
    currentGroup = groupName;
    currentCat = -1;
    document.querySelectorAll('.cat-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.group-header').forEach(el =>
        el.classList.toggle('active', el.dataset.group === groupName));

    const groupCats = allData.categories.filter(c => c.group === groupName);

    document.getElementById('catTitle').textContent = groupName;
    document.getElementById('catTitleEn').textContent = groupCats.map(c => c.name).join(' Â· ');

    // combined shortage
    const allShortage = groupCats.flatMap(c => c.shortage || []);
    renderShortageChips({ shortage: allShortage, shortageCount: allShortage.length,
        alertSummary: allShortage.some(s => s.alertLevel === 'red') ? 'red' :
            allShortage.some(s => s.alertLevel === 'yellow') ? 'yellow' :
            allShortage.length ? 'green' : null });
    renderShortageDetail({ shortage: allShortage });

    // combined summary
    const allStocks = groupCats.flatMap(c => (c.stocks || []).filter(s => !s.error));
    const combinedAvg = calcPeerAvgJS(allStocks);
    renderSummary({ peerAvg: combinedAvg });

    // Chart
    renderScatter(allStocks, combinedAvg.forwardPE);
    if (tsChart) { tsChart.destroy(); tsChart = null; }
    if (activeTab === 'timeseries') renderTimeSeries();

    // grouped table
    document.getElementById('tableHead').innerHTML = '<tr>' + COLUMNS.map(col =>
        `<th class="px-3 py-2 text-xs font-medium text-muted bg-surface border-b border-border
                    text-${col.align} ${col.w || ''} ${sortCol === col.key ? 'sorted' : ''}"
            onclick="toggleSort('${col.key}')">
            ${col.label} <span class="sort-icon">${sortCol === col.key ? (sortAsc ? 'â–²' : 'â–¼') : 'â†•'}</span>
        </th>`
    ).join('') + '</tr>';

    let html = '';
    for (const cat of groupCats) {
        const avg = cat.peerAvg || {};
        let stocks = (cat.stocks || []).filter(s => !s.error);
        stocks.sort((a, b) => {
            let va = a[sortCol], vb = b[sortCol];
            if (va == null && vb == null) return 0;
            if (va == null) return 1;
            if (vb == null) return -1;
            if (typeof va === 'string') return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
            return sortAsc ? va - vb : vb - va;
        });

        html += `<tr class="subcat-divider"><td colspan="${COLUMNS.length}">${cat.name} <span class="font-normal text-muted ml-2">${cat.name_en} Â· ${stocks.length}ì¢…ëª©</span></td></tr>`;

        for (const stock of stocks) {
            html += `<tr class="border-b border-border/30 cursor-pointer hover:bg-surface2/50" onclick="openModal('${stock.symbol}','${stock.name.replace(/'/g, "\\'")}')">` + COLUMNS.map(col => {
                const val = stock[col.key];
                if (col.key === 'name') {
                    const flag = FLAGS[stock.country] || '';
                    return `<td class="px-3 py-2 text-left ${col.w || ''}">
                        <span class="text-xs">${flag}</span>
                        <span class="font-medium text-white">${stock.name}</span>
                        <span class="text-muted text-xs ml-1">${stock.symbol}</span>
                    </td>`;
                }
                const display = fmt(val, col.format);
                const color = getColor(col, val, avg);
                return `<td class="px-3 py-2 text-${col.align} metric-cell ${color}">${display}</td>`;
            }).join('') + '</tr>';
        }

        if (stocks.length > 0) {
            html += '<tr class="peer-avg-row">' + COLUMNS.map(col => {
                if (col.key === 'name') return `<td class="px-3 py-2 text-left text-blue-400">${cat.name} Avg</td>`;
                return `<td class="px-3 py-2 text-${col.align} metric-cell">${fmt(avg[col.key], col.format)}</td>`;
            }).join('') + '</tr>';
        }
    }
    document.getElementById('tableBody').innerHTML = html;
}

function calcPeerAvgJS(stocks) {
    const metrics = ['forwardPE','trailingPE','priceToBook','enterpriseToEbitda',
        'dividendYield','returnOnEquity','fwd1y_growth','targetUpside','epsRevision30d'];
    const GROWTH_CAP = 10; // Â±1000%
    const avg = {};
    for (const m of metrics) {
        let vals = stocks.map(s => s[m]).filter(v => v != null);
        if (m === 'fwd1y_growth') vals = vals.filter(v => Math.abs(v) <= GROWTH_CAP);
        if (vals.length) {
            avg[m] = vals.reduce((a, b) => a + b, 0) / vals.length;
            const sorted = [...vals].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            avg[m + '_median'] = sorted.length % 2 === 0 ? (sorted[mid-1]+sorted[mid])/2 : sorted[mid];
        }
    }
    return avg;
}

// ========== HISTORY ==========
const historyCache = { index: null, snaps: new Map() };

async function loadHistoryIndex() {
    if (historyCache.index) return historyCache.index;
    try {
        const r = await fetch('data/history/index.json');
        if (!r.ok) return null;
        historyCache.index = await r.json();
        return historyCache.index;
    } catch { return null; }
}

async function loadSnap(date) {
    if (historyCache.snaps.has(date)) return historyCache.snaps.get(date);
    try {
        const r = await fetch(`data/history/${date}.json`);
        if (!r.ok) return null;
        const d = await r.json();
        historyCache.snaps.set(date, d);
        return d;
    } catch { return null; }
}

async function loadHistory(days = 90) {
    const idx = await loadHistoryIndex();
    if (!idx || !idx.dates.length) return [];
    const dates = idx.dates.slice(-days);
    return (await Promise.all(dates.map(loadSnap))).filter(Boolean);
}

// preload in background
async function preloadHistory() {
    await loadHistory(30);
}

// ========== TABS ==========
let activeTab = 'scatter';

function switchTab(tab) {
    activeTab = tab;
    document.getElementById('tabScatter').classList.toggle('active', tab === 'scatter');
    document.getElementById('tabTimeSeries').classList.toggle('active', tab === 'timeseries');
    document.getElementById('scatterContainer').style.display = tab === 'scatter' ? '' : 'none';
    document.getElementById('timeSeriesContainer').style.display = tab === 'timeseries' ? '' : 'none';
    if (tab === 'timeseries') renderTimeSeries();
}

let tsChart = null;

async function renderTimeSeries() {
    const history = await loadHistory(90);
    const container = document.getElementById('timeSeriesContainer');

    if (history.length < 2) {
        container.innerHTML = '<div class="flex items-center justify-center h-full text-muted text-sm">íˆìŠ¤í† ë¦¬ 2ì¼ ì´ìƒ í•„ìš” (ë§¤ì¼ ë°ì´í„° ìˆ˜ì§‘ í›„ ëˆ„ì ë©ë‹ˆë‹¤)</div>';
        return;
    }
    // restore canvas if replaced
    if (!document.getElementById('timeSeriesChart')) {
        container.innerHTML = '<canvas id="timeSeriesChart"></canvas>';
    }

    const catIds = currentGroup
        ? allData.categories.filter(c => c.group === currentGroup).map(c => c.id)
        : [allData.categories[currentCat].id];

    const dates = history.map(s => s.date);
    const avgSeries = [], minSeries = [], maxSeries = [];

    for (const snap of history) {
        const stocks = snap.stocks.filter(s => catIds.includes(s.c) && s.fpe != null);
        if (!stocks.length) { avgSeries.push(null); minSeries.push(null); maxSeries.push(null); continue; }
        const pes = stocks.map(s => s.fpe);
        avgSeries.push(+(pes.reduce((a,b) => a+b) / pes.length).toFixed(2));
        minSeries.push(Math.min(...pes));
        maxSeries.push(Math.max(...pes));
    }

    if (tsChart) tsChart.destroy();
    tsChart = new Chart(document.getElementById('timeSeriesChart'), {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                { label: 'Peer Avg P/E', data: avgSeries, borderColor: '#3b82f6', borderWidth: 2.5, tension: 0.15, spanGaps: true, pointRadius: 2 },
                { label: 'Min', data: minSeries, borderColor: '#6b728040', borderWidth: 1, borderDash: [4,4], tension: 0.15, spanGaps: true, pointRadius: 0, fill: false },
                { label: 'Max', data: maxSeries, borderColor: '#6b728040', borderWidth: 1, borderDash: [4,4], tension: 0.15, spanGaps: true, pointRadius: 0, fill: '-1', backgroundColor: '#3b82f610' },
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: true, position: 'top', labels: { color: '#e5e7eb', font: { size: 11 }, boxWidth: 12 } },
                tooltip: { backgroundColor: '#1a1d29', titleColor: '#e5e7eb', bodyColor: '#e5e7eb', borderColor: '#2a2d3a', borderWidth: 1 },
            },
            scales: {
                x: { grid: { color: '#2a2d3a40' }, ticks: { color: '#6b7280', maxRotation: 45, font: { size: 10 } } },
                y: { title: { display: true, text: 'Forward P/E', color: '#6b7280' }, grid: { color: '#2a2d3a40' }, ticks: { color: '#6b7280' } },
            },
        },
    });
}

// ========== STOCK MODAL ==========
let modalChart = null;

async function openModal(symbol, name) {
    document.getElementById('stockModal').classList.remove('hidden');
    document.getElementById('modalName').textContent = name;
    document.getElementById('modalSymbol').textContent = symbol;

    const history = await loadHistory(180);
    const cat = allData.categories.find(c => c.stocks.some(s => s.symbol === symbol));
    const catId = cat?.id;

    const dates = [], fpeArr = [], tpeArr = [], peerArr = [];
    for (const snap of history) {
        const stock = snap.stocks.find(s => s.s === symbol);
        if (!stock) continue;
        dates.push(snap.date);
        fpeArr.push(stock.fpe);
        tpeArr.push(stock.tpe);
        const peers = snap.stocks.filter(s => s.c === catId && s.fpe != null);
        peerArr.push(peers.length ? +(peers.reduce((a,b) => a + b.fpe, 0) / peers.length).toFixed(2) : null);
    }

    if (!document.getElementById('modalChart')) {
        document.querySelector('#stockModal .bg-bg').innerHTML = '<canvas id="modalChart"></canvas>';
    }
    if (modalChart) modalChart.destroy();

    if (dates.length < 2) {
        document.querySelector('#stockModal .bg-bg').innerHTML = '<div class="flex items-center justify-center h-full text-muted text-sm">íˆìŠ¤í† ë¦¬ 2ì¼ ì´ìƒ í•„ìš”</div>';
    } else {
        modalChart = new Chart(document.getElementById('modalChart'), {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    { label: 'Forward P/E', data: fpeArr, borderColor: '#3b82f6', borderWidth: 2.5, tension: 0.2, spanGaps: true, pointRadius: 2 },
                    { label: 'Trailing P/E', data: tpeArr, borderColor: '#f59e0b', borderWidth: 2, tension: 0.2, spanGaps: true, pointRadius: 1 },
                    { label: 'Peer Avg', data: peerArr, borderColor: '#6b7280', borderWidth: 1.5, borderDash: [5,5], tension: 0.2, spanGaps: true, pointRadius: 0 },
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: true, position: 'top', labels: { color: '#e5e7eb', font: { size: 11 }, boxWidth: 12 } }, tooltip: { backgroundColor: '#1a1d29', titleColor: '#e5e7eb', bodyColor: '#e5e7eb' } },
                scales: {
                    x: { grid: { color: '#2a2d3a40' }, ticks: { color: '#6b7280', font: { size: 10 } } },
                    y: { title: { display: true, text: 'P/E', color: '#6b7280' }, grid: { color: '#2a2d3a40' }, ticks: { color: '#6b7280' } },
                },
            },
        });
    }

    // Stats
    const valid = fpeArr.filter(v => v != null);
    const last30 = valid.slice(-30), last90 = valid.slice(-90);
    const stats = [
        { label: 'Current P/E', value: valid.length ? valid[valid.length-1].toFixed(2) : '-', sub: peerArr.length && peerArr[peerArr.length-1] ? `vs peer ${peerArr[peerArr.length-1].toFixed(2)}` : '' },
        { label: '30D Range', value: last30.length ? `${Math.min(...last30).toFixed(1)} - ${Math.max(...last30).toFixed(1)}` : '-', sub: last30.length ? `Avg ${(last30.reduce((a,b)=>a+b)/last30.length).toFixed(2)}` : '' },
        { label: '90D Range', value: last90.length >= 2 ? `${Math.min(...last90).toFixed(1)} - ${Math.max(...last90).toFixed(1)}` : '-', sub: last90.length >= 2 ? `Avg ${(last90.reduce((a,b)=>a+b)/last90.length).toFixed(2)}` : '' },
        { label: 'All Data', value: valid.length >= 2 ? `${Math.min(...valid).toFixed(1)} - ${Math.max(...valid).toFixed(1)}` : '-', sub: `${valid.length} data points` },
    ];
    document.getElementById('modalStats').innerHTML = stats.map(s =>
        `<div class="stat-card"><div class="text-xs text-muted">${s.label}</div><div class="text-lg font-bold text-white mt-1">${s.value}</div><div class="text-xs text-muted mt-0.5">${s.sub}</div></div>`
    ).join('');
}

function closeModal() {
    document.getElementById('stockModal').classList.add('hidden');
    if (modalChart) { modalChart.destroy(); modalChart = null; }
}

// Close modal on Escape
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

let scatterChart = null;

function renderScatter(stocks, avgPE) {
    const canvas = document.getElementById('scatterChart');
    if (scatterChart) { scatterChart.destroy(); scatterChart = null; }

    const GROWTH_CAP = 10;
    const points = stocks
        .filter(s => !s.error && s.forwardPE != null && s.fwd1y_growth != null && Math.abs(s.fwd1y_growth) <= GROWTH_CAP)
        .map(s => ({
            x: s.fwd1y_growth * 100,
            y: s.forwardPE,
            label: s.name,
            symbol: s.symbol,
            country: s.country,
        }));

    if (points.length < 2) {
        document.getElementById('scatterContainer').style.display = 'none';
        return;
    }
    document.getElementById('scatterContainer').style.display = '';

    scatterChart = new Chart(canvas, {
        type: 'scatter',
        data: {
            datasets: [{
                data: points,
                backgroundColor: points.map(p => {
                    if (avgPE && p.y < avgPE && p.x > 0) return '#22c55e99';
                    if (avgPE && p.y > avgPE && p.x < 0) return '#ef444499';
                    return '#3b82f699';
                }),
                borderColor: points.map(p => {
                    if (avgPE && p.y < avgPE && p.x > 0) return '#22c55e';
                    if (avgPE && p.y > avgPE && p.x < 0) return '#ef4444';
                    return '#3b82f6';
                }),
                borderWidth: 1.5,
                pointRadius: 6,
                pointHoverRadius: 9,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const p = ctx.raw;
                            return `${p.label} (${p.symbol}) â€” P/E ${p.y.toFixed(1)}, EPS Growth ${p.x > 0 ? '+' : ''}${p.x.toFixed(1)}%`;
                        }
                    },
                    backgroundColor: '#1a1d29',
                    titleColor: '#e5e7eb',
                    bodyColor: '#e5e7eb',
                    borderColor: '#2a2d3a',
                    borderWidth: 1,
                },
            },
            scales: {
                x: {
                    title: { display: true, text: 'EPS Growth (FY+1, %)', color: '#6b7280', font: { size: 11 } },
                    grid: { color: '#2a2d3a40' },
                    ticks: { color: '#6b7280', callback: v => v + '%' },
                },
                y: {
                    title: { display: true, text: 'Forward P/E', color: '#6b7280', font: { size: 11 } },
                    grid: { color: '#2a2d3a40' },
                    ticks: { color: '#6b7280' },
                    reverse: false,
                },
            },
        },
        plugins: [{
            id: 'dataLabels',
            afterDatasetsDraw(chart) {
                const ctx = chart.ctx;
                ctx.font = '10px -apple-system, sans-serif';
                ctx.fillStyle = '#9ca3af';
                ctx.textAlign = 'center';
                chart.data.datasets[0].data.forEach((p, i) => {
                    const meta = chart.getDatasetMeta(0).data[i];
                    if (meta) ctx.fillText(p.label, meta.x, meta.y - 10);
                });
            }
        }]
    });
}

loadData();
</script>
</body>
</html>
